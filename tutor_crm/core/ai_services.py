import openai
import os
import requests
import json
from django.conf import settings
from .models import Student, Lesson, Homework
from .math_database import MATH_6_GRADE_DATABASE, HOMEWORK_TASKS

class AITutorService:
    def __init__(self):
        # Используем переменную окружения для API ключа
        self.api_key = os.getenv('OPENAI_API_KEY')
        self.ai_provider = os.getenv('AI_PROVIDER', 'openai')  # openai, local, mock
        
        if self.api_key and self.ai_provider == 'openai':
            try:
                self.client = openai.OpenAI(api_key=self.api_key)
            except Exception as e:
                print(f"Ошибка инициализации OpenAI: {e}")
                self.client = None
        else:
            self.client = None
    
    def _get_math_6_grade_database(self):
        """База знаний для математики 6 класса"""
        return {
            # ГЛАВА 1: ДЕСЯТИЧНЫЕ ДРОБИ
            "десятичные дроби": {
                "title": "Десятичные дроби",
                "objectives": [
                    "Изучить понятие десятичной дроби",
                    "Научиться читать и записывать десятичные дроби",
                    "Освоить разряды десятичных дробей"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Организационный момент",
                        "description": "Приветствие, проверка готовности, объявление темы 'Десятичные дроби'"
                    },
                    {
                        "time": "5-15 мин",
                        "activity": "Повторение обыкновенных дробей",
                        "description": "Вспоминаем понятие дроби, числитель, знаменатель, связь с делением"
                    },
                    {
                        "time": "15-30 мин",
                        "activity": "Изучение десятичной записи",
                        "description": "Объяснение десятичной записи дробей, разряды: десятые, сотые, тысячные"
                    },
                    {
                        "time": "30-45 мин",
                        "activity": "Практическая работа",
                        "description": "Запись дробей в десятичном виде: 3/10 = 0.3, 25/100 = 0.25"
                    },
                    {
                        "time": "45-55 мин",
                        "activity": "Закрепление",
                        "description": "Решение задач на запись и чтение десятичных дробей"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Подведение итогов",
                        "description": "Повторение ключевых моментов, домашнее задание"
                    }
                ],
                "materials": [
                    "Учебник математики 6 класс",
                    "Тетрадь для записей",
                    "Калькулятор",
                    "Линейка",
                    "Таблица разрядов"
                ],
                "homework": "1) Изучить §1 учебника\n2) Записать в десятичном виде: 7/10, 13/100, 5/1000\n3) Прочитать десятичные дроби: 0.8, 0.25, 0.007",
                "notes": "Обратить внимание на правильное произношение десятичных дробей"
            },
            
            "сравнение десятичных дробей": {
                "title": "Сравнение и округление десятичных дробей",
                "objectives": [
                    "Научиться сравнивать десятичные дроби",
                    "Освоить правила округления",
                    "Применять знания на практике"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Проверка домашнего задания",
                        "description": "Разбор ошибок, повторение десятичной записи"
                    },
                    {
                        "time": "5-20 мин",
                        "activity": "Сравнение десятичных дробей",
                        "description": "Правила сравнения: по целой части, по разрядам, приведение к общему знаменателю"
                    },
                    {
                        "time": "20-35 мин",
                        "activity": "Округление дробей",
                        "description": "Правила округления, знак ≥, примеры: 3.456 ≈ 3.46"
                    },
                    {
                        "time": "35-50 мин",
                        "activity": "Практика",
                        "description": "Сравнить: 0.7 и 0.69, округлить 2.345 до сотых"
                    },
                    {
                        "time": "50-55 мин",
                        "activity": "Закрепление",
                        "description": "Самостоятельная работа с проверкой"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Итоги",
                        "description": "Повторение правил, домашнее задание"
                    }
                ],
                "materials": [
                    "Учебник §2",
                    "Тетрадь",
                    "Калькулятор",
                    "Карточки с заданиями"
                ],
                "homework": "1) Сравнить: 0.8 и 0.79, 2.5 и 2.50\n2) Округлить: 3.456 до сотых, 7.891 до десятых\n3) Решить №15-17 из учебника",
                "notes": "Подчеркнуть важность внимательности при сравнении"
            },
            
            "сложение вычитание десятичных дробей": {
                "title": "Сложение и вычитание десятичных дробей",
                "objectives": [
                    "Изучить алгоритм сложения десятичных дробей",
                    "Освоить вычитание десятичных дробей",
                    "Научиться решать задачи"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Повторение",
                        "description": "Проверка домашнего, повторение сравнения дробей"
                    },
                    {
                        "time": "5-20 мин",
                        "activity": "Сложение дробей",
                        "description": "Алгоритм сложения: записать в столбик, выровнять по запятой, сложить по разрядам"
                    },
                    {
                        "time": "20-35 мин",
                        "activity": "Вычитание дробей",
                        "description": "Алгоритм вычитания, заимствование единиц, примеры"
                    },
                    {
                        "time": "35-50 мин",
                        "activity": "Практика",
                        "description": "Решить: 2.5 + 1.7, 5.3 - 2.8, 10.5 + 3.25"
                    },
                    {
                        "time": "50-55 мин",
                        "activity": "Задачи",
                        "description": "Текстовые задачи на сложение и вычитание"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Итоги",
                        "description": "Повторение алгоритмов, домашнее задание"
                    }
                ],
                "materials": [
                    "Учебник §4",
                    "Тетрадь",
                    "Калькулятор",
                    "Карточки с примерами"
                ],
                "homework": "1) Решить: 3.2 + 1.8, 7.5 - 2.3, 12.4 + 5.67\n2) Задача: В магазине купили товар за 15.7 руб и 8.3 руб. Сколько заплатили?\n3) №25-28 из учебника",
                "notes": "Важно выравнивание по запятой при записи в столбик"
            },
            
            "умножение десятичных дробей": {
                "title": "Умножение десятичных дробей",
                "objectives": [
                    "Изучить правила умножения десятичных дробей",
                    "Научиться умножать на разрядные единицы",
                    "Освоить умножение дробей друг на друга"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Проверка ДЗ",
                        "description": "Разбор ошибок, повторение сложения"
                    },
                    {
                        "time": "5-20 мин",
                        "activity": "Умножение на 10, 100, 1000",
                        "description": "Правило: перенос запятой вправо, примеры: 2.5 × 10 = 25"
                    },
                    {
                        "time": "20-35 мин",
                        "activity": "Умножение дробей",
                        "description": "Алгоритм: умножить как натуральные числа, поставить запятую по правилу"
                    },
                    {
                        "time": "35-50 мин",
                        "activity": "Практика",
                        "description": "Решить: 0.3 × 0.4, 2.5 × 1.2, 0.7 × 10"
                    },
                    {
                        "time": "50-55 мин",
                        "activity": "Задачи",
                        "description": "Задачи на умножение: площадь, скорость, цена"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Итоги",
                        "description": "Повторение правил, домашнее задание"
                    }
                ],
                "materials": [
                    "Учебник §6",
                    "Тетрадь",
                    "Калькулятор",
                    "Таблица умножения"
                ],
                "homework": "1) Решить: 0.6 × 0.5, 3.2 × 1.5, 0.8 × 100\n2) Задача: Длина прямоугольника 2.5 м, ширина 1.8 м. Найти площадь\n3) №35-38 из учебника",
                "notes": "Повторить таблицу умножения для быстрого счета"
            },
            
            "деление десятичных дробей": {
                "title": "Деление десятичных дробей",
                "objectives": [
                    "Изучить деление на натуральное число",
                    "Освоить деление на десятичную дробь",
                    "Научиться решать задачи"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Проверка ДЗ",
                        "description": "Разбор ошибок, повторение умножения"
                    },
                    {
                        "time": "5-20 мин",
                        "activity": "Деление на натуральное число",
                        "description": "Алгоритм деления в столбик, перенос запятой в частном"
                    },
                    {
                        "time": "20-35 мин",
                        "activity": "Деление на десятичную дробь",
                        "description": "Приведение к делению на натуральное число, правило переноса запятой"
                    },
                    {
                        "time": "35-50 мин",
                        "activity": "Практика",
                        "description": "Решить: 6.3 ÷ 3, 8.4 ÷ 0.4, 12.5 ÷ 2.5"
                    },
                    {
                        "time": "50-55 мин",
                        "activity": "Задачи",
                        "description": "Задачи на деление: скорость, цена, производительность"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Итоги",
                        "description": "Повторение алгоритмов, домашнее задание"
                    }
                ],
                "materials": [
                    "Учебник §7-8",
                    "Тетрадь",
                    "Калькулятор",
                    "Карточки с примерами"
                ],
                "homework": "1) Решить: 9.6 ÷ 4, 7.2 ÷ 0.8, 15.5 ÷ 3.1\n2) Задача: 12 кг конфет стоят 360 руб. Сколько стоит 1 кг?\n3) №45-48 из учебника",
                "notes": "Внимательно следить за переносом запятой"
            },
            
            # ГЛАВА 2: ПРОЦЕНТЫ И ПРОПОРЦИИ
            "проценты": {
                "title": "Проценты",
                "objectives": [
                    "Понять, что такое процент",
                    "Научиться переводить проценты в дроби",
                    "Освоить основные задачи на проценты"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Введение в тему",
                        "description": "Объяснение понятия процента, связь с сотыми долями"
                    },
                    {
                        "time": "5-20 мин",
                        "activity": "Перевод процентов",
                        "description": "1% = 1/100, 25% = 25/100 = 0.25, примеры перевода"
                    },
                    {
                        "time": "20-35 мин",
                        "activity": "Основные задачи",
                        "description": "Найти процент от числа, найти число по проценту, найти процентное отношение"
                    },
                    {
                        "time": "35-50 мин",
                        "activity": "Практика",
                        "description": "Решить: 20% от 150, 15% от 200, найти 25% от числа, если это 50"
                    },
                    {
                        "time": "50-55 мин",
                        "activity": "Задачи",
                        "description": "Жизненные задачи: скидки, налоги, банковские проценты"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Итоги",
                        "description": "Повторение формул, домашнее задание"
                    }
                ],
                "materials": [
                    "Учебник §1-2",
                    "Тетрадь",
                    "Калькулятор",
                    "Карточки с задачами"
                ],
                "homework": "1) Перевести в проценты: 0.25, 0.6, 0.08\n2) Найти: 30% от 400, 15% от 120\n3) Задача: Товар стоил 2000 руб, скидка 15%. Новая цена?\n4) №55-58 из учебника",
                "notes": "Процент - это сотая часть числа"
            },
            
            "пропорции": {
                "title": "Пропорции",
                "objectives": [
                    "Изучить понятие пропорции",
                    "Освоить основное свойство пропорции",
                    "Научиться решать задачи с помощью пропорций"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Проверка ДЗ",
                        "description": "Разбор ошибок, повторение процентов"
                    },
                    {
                        "time": "5-20 мин",
                        "activity": "Понятие пропорции",
                        "description": "Равенство двух отношений, запись a:b = c:d"
                    },
                    {
                        "time": "20-35 мин",
                        "activity": "Основное свойство",
                        "description": "a×d = b×c, проверка пропорции, нахождение неизвестного члена"
                    },
                    {
                        "time": "35-50 мин",
                        "activity": "Решение задач",
                        "description": "Задачи на пропорциональность: скорость, время, расстояние"
                    },
                    {
                        "time": "50-55 мин",
                        "activity": "Практика",
                        "description": "Решить пропорции: x:3 = 4:6, 2:5 = 8:x"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Итоги",
                        "description": "Повторение свойств, домашнее задание"
                    }
                ],
                "materials": [
                    "Учебник §3-5",
                    "Тетрадь",
                    "Калькулятор",
                    "Карточки с пропорциями"
                ],
                "homework": "1) Решить пропорции: x:4 = 3:12, 5:2 = 15:x\n2) Задача: 3 кг яблок стоят 150 руб. Сколько стоят 7 кг?\n3) №65-68 из учебника",
                "notes": "Проверять пропорцию умножением крест-накрест"
            },
            
            "масштаб": {
                "title": "Масштаб",
                "objectives": [
                    "Понять, что такое масштаб",
                    "Научиться работать с масштабом",
                    "Решать задачи на масштаб"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Введение",
                        "description": "Объяснение масштаба, примеры из жизни: карты, чертежи"
                    },
                    {
                        "time": "5-20 мин",
                        "activity": "Понятие масштаба",
                        "description": "Масштаб 1:1000 означает, что 1 см на карте = 1000 см в реальности"
                    },
                    {
                        "time": "20-35 мин",
                        "activity": "Решение задач",
                        "description": "Найти реальное расстояние, если на карте 5 см при масштабе 1:50000"
                    },
                    {
                        "time": "35-50 мин",
                        "activity": "Практика",
                        "description": "Задачи на масштаб: карты, планы, чертежи"
                    },
                    {
                        "time": "50-55 мин",
                        "activity": "Закрепление",
                        "description": "Самостоятельная работа с проверкой"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Итоги",
                        "description": "Повторение формул, домашнее задание"
                    }
                ],
                "materials": [
                    "Учебник §6",
                    "Тетрадь",
                    "Линейка",
                    "Карта или план",
                    "Калькулятор"
                ],
                "homework": "1) На карте масштаба 1:50000 расстояние 3 см. Реальное расстояние?\n2) Реальное расстояние 2 км. На карте масштаба 1:100000 это сколько см?\n3) №75-78 из учебника",
                "notes": "Масштаб показывает отношение размеров на чертеже к реальным"
            },
            
            # ГЛАВА 3: МНОЖЕСТВО
            "множества": {
                "title": "Множества",
                "objectives": [
                    "Изучить понятие множества",
                    "Научиться задавать множества",
                    "Освоить операции над множествами"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Введение",
                        "description": "Объяснение понятия множества, примеры из жизни"
                    },
                    {
                        "time": "5-20 мин",
                        "activity": "Элементы множества",
                        "description": "Элементы, принадлежность, пустое множество, примеры"
                    },
                    {
                        "time": "20-35 мин",
                        "activity": "Способы задания",
                        "description": "Перечисление элементов, характеристическое свойство"
                    },
                    {
                        "time": "35-50 мин",
                        "activity": "Операции",
                        "description": "Пересечение, объединение множеств, примеры"
                    },
                    {
                        "time": "50-55 мин",
                        "activity": "Круги Эйлера",
                        "description": "Графическое представление множеств"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Итоги",
                        "description": "Повторение понятий, домашнее задание"
                    }
                ],
                "materials": [
                    "Учебник §1-4",
                    "Тетрадь",
                    "Цветные карандаши",
                    "Карточки с множествами"
                ],
                "homework": "1) Задать множества: четные числа до 10, буквы слова 'математика'\n2) Найти пересечение и объединение множеств\n3) Изобразить кругами Эйлера\n4) №85-88 из учебника",
                "notes": "Множество - это совокупность объектов"
            },
            
            # ГЛАВА 4: РАЦИОНАЛЬНЫЕ ЧИСЛА
            "рациональные числа": {
                "title": "Рациональные числа",
                "objectives": [
                    "Изучить положительные и отрицательные числа",
                    "Освоить модуль числа",
                    "Научиться выполнять действия с рациональными числами"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Введение",
                        "description": "Объяснение отрицательных чисел, примеры из жизни"
                    },
                    {
                        "time": "5-20 мин",
                        "activity": "Координатная прямая",
                        "description": "Изображение чисел на прямой, положительные и отрицательные"
                    },
                    {
                        "time": "20-35 мин",
                        "activity": "Модуль числа",
                        "description": "Определение модуля, свойства, примеры"
                    },
                    {
                        "time": "35-50 мин",
                        "activity": "Сложение и вычитание",
                        "description": "Правила сложения чисел с разными знаками"
                    },
                    {
                        "time": "50-55 мин",
                        "activity": "Умножение и деление",
                        "description": "Правила знаков при умножении и делении"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Итоги",
                        "description": "Повторение правил, домашнее задание"
                    }
                ],
                "materials": [
                    "Учебник §1-9",
                    "Тетрадь",
                    "Координатная прямая",
                    "Калькулятор"
                ],
                "homework": "1) Найти модули: |-5|, |3|, |-2.5|\n2) Вычислить: -3 + 5, 2 - 7, -4 × (-3)\n3) Решить: -12 ÷ 4, -8 + (-3)\n4) №95-98 из учебника",
                "notes": "При сложении чисел с разными знаками вычитаем из большего меньшее"
            },
            
            # ГЛАВА 5: КООРДИНАТНАЯ ПЛОСКОСТЬ
            "координатная плоскость": {
                "title": "Координатная плоскость",
                "objectives": [
                    "Изучить прямоугольную систему координат",
                    "Научиться строить точки по координатам",
                    "Освоить построение графиков"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Введение",
                        "description": "Объяснение координатной плоскости, оси OX и OY"
                    },
                    {
                        "time": "5-20 мин",
                        "activity": "Координаты точки",
                        "description": "Абсцисса и ордината, запись (x, y), примеры"
                    },
                    {
                        "time": "20-35 мин",
                        "activity": "Построение точек",
                        "description": "Алгоритм построения точки по координатам"
                    },
                    {
                        "time": "35-50 мин",
                        "activity": "Графики",
                        "description": "Прямая пропорциональность y = kx, обратная y = k/x"
                    },
                    {
                        "time": "50-55 мин",
                        "activity": "Практика",
                        "description": "Построить точки: (2, 3), (-1, 4), (0, -2)"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Итоги",
                        "description": "Повторение алгоритмов, домашнее задание"
                    }
                ],
                "materials": [
                    "Учебник §1-3",
                    "Тетрадь",
                    "Координатная сетка",
                    "Цветные карандаши",
                    "Линейка"
                ],
                "homework": "1) Построить точки: (3, 2), (-2, 1), (0, 4)\n2) Построить график y = 2x\n3) Построить график y = 6/x\n4) №105-108 из учебника",
                "notes": "Сначала откладываем по оси OX, затем по оси OY"
            },
            
            # ГЛАВА 6: НАГЛЯДНАЯ ГЕОМЕТРИЯ
            "геометрия": {
                "title": "Наглядная геометрия",
                "objectives": [
                    "Изучить геометрические фигуры",
                    "Освоить формулы площади и периметра",
                    "Научиться строить симметричные фигуры"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Введение",
                        "description": "Объяснение наглядной геометрии, примеры из жизни"
                    },
                    {
                        "time": "5-20 мин",
                        "activity": "Окружность и круг",
                        "description": "Радиус, диаметр, формулы длины окружности и площади круга"
                    },
                    {
                        "time": "20-35 мин",
                        "activity": "Треугольники",
                        "description": "Виды треугольников: остроугольные, прямоугольные, тупоугольные"
                    },
                    {
                        "time": "35-50 мин",
                        "activity": "Симметрия",
                        "description": "Симметрия относительно точки и прямой, построение"
                    },
                    {
                        "time": "50-55 мин",
                        "activity": "Практика",
                        "description": "Построение окружности, треугольника, симметричных фигур"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Итоги",
                        "description": "Повторение формул, домашнее задание"
                    }
                ],
                "materials": [
                    "Учебник §2-5",
                    "Тетрадь",
                    "Циркуль",
                    "Линейка",
                    "Цветные карандаши"
                ],
                "homework": "1) Найти длину окружности радиуса 5 см\n2) Найти площадь круга радиуса 3 см\n3) Построить равносторонний треугольник\n4) Построить фигуру, симметричную относительно точки\n5) №115-118 из учебника",
                "notes": "L = 2πr, S = πr², π ≈ 3.14"
            }
        }
    
    def _call_mock_ai(self, prompt, system_prompt):
        """Мок AI с базой знаний для математики 6 класса"""
        database = MATH_6_GRADE_DATABASE
        
        def find_topic_in_prompt(prompt_text):
            """Улучшенный поиск темы в запросе"""
            prompt_lower = prompt_text.lower()
            
            # Словарь синонимов и вариантов названий тем
            topic_variants = {
                "десятичные дроби": ["десятичные дроби", "десятичная дробь", "десятичные", "дроби десятичные"],
                "сравнение десятичных дробей": ["сравнение десятичных дробей", "сравнение дробей", "округление дробей", "сравнение и округление"],
                "сложение и вычитание десятичных дробей": ["сложение десятичных дробей", "вычитание десятичных дробей", "сложение дробей", "вычитание дробей", "сложение и вычитание"],
                "умножение десятичных дробей": ["умножение десятичных дробей", "умножение дробей", "умножение"],
                "деление десятичных дробей": ["деление десятичных дробей", "деление дробей", "деление"],
                "проценты": ["проценты", "процент", "процентные задачи"],
                "пропорции": ["пропорции", "пропорция", "пропорциональность"],
                "координатная плоскость": ["координатная плоскость", "координаты", "плоскость", "оси координат"],
                "положительные и отрицательные числа": ["положительные и отрицательные числа", "отрицательные числа", "положительные числа", "рациональные числа"],
                "сложение и вычитание рациональных чисел": ["сложение рациональных чисел", "вычитание рациональных чисел", "сложение и вычитание рациональных"],
                "умножение и деление рациональных чисел": ["умножение рациональных чисел", "деление рациональных чисел", "умножение и деление рациональных"]
            }
            
            # Ищем тему по вариантам названий
            for topic_key, variants in topic_variants.items():
                for variant in variants:
                    if variant in prompt_lower:
                        return topic_key
            
            # Если не найдено по вариантам, ищем по ключевым словам
            for topic_key in database.keys():
                if topic_key in prompt_lower:
                    return topic_key
            
            return None
        
        # Определяем тип запроса
        if "планирование урока" in prompt.lower() or "спланируй урок" in prompt.lower():
            # Ищем тему в базе знаний
            found_topic = find_topic_in_prompt(prompt)
            
            if found_topic and found_topic in database:
                return database[found_topic]
            
            # Если тема не найдена, возвращаем общий план
            return {
                "title": "Урок по математике",
                "objectives": [
                    "Изучить новую тему",
                    "Закрепить материал на практике",
                    "Подготовить домашнее задание"
                ],
                "structure": [
                    {
                        "time": "0-5 мин",
                        "activity": "Организационный момент",
                        "description": "Приветствие, проверка готовности к уроку"
                    },
                    {
                        "time": "5-15 мин",
                        "activity": "Проверка домашнего задания",
                        "description": "Разбор ошибок, ответы на вопросы"
                    },
                    {
                        "time": "15-35 мин",
                        "activity": "Изучение новой темы",
                        "description": "Объяснение теории, разбор примеров"
                    },
                    {
                        "time": "35-50 мин",
                        "activity": "Практическая работа",
                        "description": "Решение задач, индивидуальная помощь"
                    },
                    {
                        "time": "50-55 мин",
                        "activity": "Закрепление материала",
                        "description": "Повторение ключевых моментов"
                    },
                    {
                        "time": "55-60 мин",
                        "activity": "Подведение итогов",
                        "description": "Объяснение домашнего задания"
                    }
                ],
                "materials": [
                    "Учебник математики 6 класс",
                    "Тетрадь для записей",
                    "Калькулятор",
                    "Линейка и карандаш"
                ],
                "homework": "1) Изучить теорию в учебнике\n2) Решить задачи из учебника\n3) Подготовить вопросы",
                "notes": "Обратить внимание на типичные ошибки ученика"
            }
        
        elif "домашнее задание" in prompt.lower() or "создай домашнее задание" in prompt.lower():
            # Ищем тему для домашнего задания
            found_topic = find_topic_in_prompt(prompt)
            
            if found_topic and found_topic in database:
                topic_data = database[found_topic]
                # Используем задания из базы знаний
                tasks = HOMEWORK_TASKS.get(found_topic, [
                    {
                        "number": 1,
                        "task": "Изучить теорию в учебнике",
                        "hint": "Внимательно прочитайте параграф"
                    },
                    {
                        "number": 2,
                        "task": "Решить задачи из учебника",
                        "hint": "Используйте изученные правила"
                    },
                    {
                        "number": 3,
                        "task": "Подготовить вопросы по непонятным моментам",
                        "hint": "Запишите то, что вызывает затруднения"
                    }
                ])
                
                return {
                    "title": f"Домашнее задание по теме '{topic_data['title']}'",
                    "description": f"Закрепление пройденного материала. Выполните все задания письменно в тетради.",
                    "tasks": tasks,
                    "estimated_time": "45 минут",
                    "difficulty": "Средняя"
                }
            
            # Если тема не найдена, возвращаем общее задание
            return {
                "title": "Домашнее задание по математике",
                "description": "Закрепление пройденного материала. Выполните все задания письменно в тетради.",
                "tasks": [
                    {
                        "number": 1,
                        "task": "Изучить теорию в учебнике",
                        "hint": "Внимательно прочитайте параграф"
                    },
                    {
                        "number": 2,
                        "task": "Решить задачи из учебника",
                        "hint": "Используйте изученные правила"
                    },
                    {
                        "number": 3,
                        "task": "Подготовить вопросы по непонятным моментам",
                        "hint": "Запишите то, что вызывает затруднения"
                    }
                ],
                "estimated_time": "45 минут",
                "difficulty": "Средняя"
            }
        
        else:
            # Анализ прогресса ученика
            return {
                "progress_summary": "Ученик демонстрирует стабильный прогресс в изучении математики 6 класса. Показывает хорошее понимание теоретического материала, но нуждается в дополнительной практике для закрепления навыков решения задач.",
                "strengths": [
                    "Отличное логическое мышление",
                    "Внимательность к деталям",
                    "Хорошая память на формулы",
                    "Активность на уроках",
                    "Усидчивость при решении задач"
                ],
                "weaknesses": [
                    "Нужна практика в решении сложных задач",
                    "Иногда торопится и допускает ошибки в вычислениях",
                    "Требуется больше времени на анализ условия задачи",
                    "Слабое знание таблицы умножения"
                ],
                "recommendations": [
                    "Увеличить количество практических заданий",
                    "Повторять теорию перед каждым новым разделом",
                    "Развивать навыки самопроверки",
                    "Использовать больше наглядных примеров",
                    "Повторить таблицу умножения"
                ],
                "next_topics": [
                    "Десятичные дроби",
                    "Проценты и пропорции",
                    "Рациональные числа",
                    "Координатная плоскость",
                    "Геометрические задачи"
                ],
                "motivation_tips": [
                    "Хвалите за каждый успешный шаг",
                    "Ставьте достижимые краткосрочные цели",
                    "Показывайте связь математики с реальной жизнью",
                    "Создавайте позитивную атмосферу на уроках",
                    "Используйте игровые элементы"
                ]
            }
    
    def _call_local_ai(self, prompt, system_prompt):
        """Локальный AI сервис (можно настроить под свои нужды)"""
        # Здесь можно подключить локальный AI сервис
        # Например, Ollama, локальный GPT или другой сервис
        return self._call_mock_ai(prompt, system_prompt)
    
    def _make_ai_request(self, prompt, system_prompt, max_tokens=1000):
        """Универсальный метод для AI запросов"""
        try:
            if self.ai_provider == 'openai' and self.client:
                response = self.client.chat.completions.create(
                    model="gpt-3.5-turbo",
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": prompt}
                    ],
                    max_tokens=max_tokens,
                    temperature=0.7
                )
                return json.loads(response.choices[0].message.content)
            elif self.ai_provider == 'local':
                return self._call_local_ai(prompt, system_prompt)
            else:
                return self._call_mock_ai(prompt, system_prompt)
        except Exception as e:
            print(f"Ошибка AI запроса: {e}")
            return self._call_mock_ai(prompt, system_prompt)
    
    def plan_lesson(self, student, topic=None, duration=60):
        """Планирует урок с помощью AI"""
        if not self.api_key and self.ai_provider == 'openai':
            return {
                'success': False,
                'error': 'API ключ не настроен'
            }
        
        try:
            # Собираем информацию об ученике
            student_info = f"""
            Ученик: {student.name}
            Класс: {student.grade}
            Школа: {student.school}
            Цель занятий: {student.goal}
            Заметки: {student.notes}
            """
            
            # Получаем историю занятий
            recent_lessons = student.lessons.all().order_by('-date')[:5]
            lesson_history = ""
            for lesson in recent_lessons:
                lesson_history += f"- {lesson.date}: {lesson.topic}\n"
            
            prompt = f"""
            Ты опытный репетитор. Спланируй урок для ученика.
            
            {student_info}
            
            Последние занятия:
            {lesson_history}
            
            Тема урока: {topic or 'Продолжение предыдущей темы'}
            Длительность: {duration} минут
            
            Создай план урока в формате JSON:
            {{
                "title": "Название урока",
                "objectives": ["Цель 1", "Цель 2"],
                "structure": [
                    {{
                        "time": "0-10 мин",
                        "activity": "Описание активности",
                        "description": "Подробное описание"
                    }}
                ],
                "materials": ["Материал 1", "Материал 2"],
                "homework": "Домашнее задание",
                "notes": "Дополнительные заметки"
            }}
            """
            
            response = self._make_ai_request(prompt, "Ты опытный репетитор, который создает качественные планы уроков.")
            
            lesson_plan = response
            return {
                'success': True,
                'plan': lesson_plan
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e)
            }
    
    def generate_homework(self, student, lesson_topic, difficulty="medium"):
        """Генерирует домашнее задание с помощью AI"""
        if not self.api_key and self.ai_provider == 'openai':
            return {
                'success': False,
                'error': 'API ключ не настроен'
            }
        
        try:
            prompt = f"""
            Создай домашнее задание для ученика.
            
            Ученик: {student.name}
            Класс: {student.grade}
            Тема урока: {lesson_topic}
            Сложность: {difficulty}
            
            Создай задание в формате JSON:
            {{
                "title": "Название задания",
                "description": "Описание задания",
                "tasks": [
                    {{
                        "number": 1,
                        "task": "Описание задачи",
                        "hint": "Подсказка (опционально)"
                    }}
                ],
                "estimated_time": "Примерное время выполнения",
                "difficulty": "Сложность"
            }}
            """
            
            response = self._make_ai_request(prompt, "Ты опытный учитель, создающий качественные домашние задания.")
            
            homework = response
            return {
                'success': True,
                'homework': homework
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e)
            }
    
    def analyze_student_progress(self, student):
        """Анализирует прогресс ученика с помощью AI"""
        if not self.api_key and self.ai_provider == 'openai':
            return {
                'success': False,
                'error': 'API ключ не настроен'
            }
        
        try:
            # Получаем все занятия ученика
            lessons = student.lessons.all().order_by('date')
            homework = student.homeworks.all()
            
            lessons_summary = ""
            for lesson in lessons:
                lessons_summary += f"- {lesson.date}: {lesson.topic}\n"
            
            homework_summary = ""
            completed = 0
            for hw in homework:
                status = "✅" if hw.is_done else "❌"
                homework_summary += f"- {status} {hw.task[:50]}...\n"
                if hw.is_done:
                    completed += 1
            
            prompt = f"""
            Проанализируй прогресс ученика и дай рекомендации.
            
            Ученик: {student.name}
            Класс: {student.grade}
            Цель: {student.goal}
            
            История занятий:
            {lessons_summary}
            
            Домашние задания:
            {homework_summary}
            Выполнено: {completed}/{len(homework)} заданий
            
            Дай анализ в формате JSON:
            {{
                "progress_summary": "Общая оценка прогресса",
                "strengths": ["Сильные стороны"],
                "weaknesses": ["Области для улучшения"],
                "recommendations": ["Рекомендации"],
                "next_topics": ["Следующие темы для изучения"],
                "motivation_tips": ["Советы по мотивации"]
            }}
            """
            
            response = self._make_ai_request(prompt, "Ты опытный педагог-психолог, анализирующий прогресс учеников.")
            
            analysis = response
            return {
                'success': True,
                'analysis': analysis
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e)
            } 